import{N as j,o as it,E as nt,S as ct,O as ht,V as mt,c as gt,g as J,t as at,b as Y,s as c,i as F,a as G,F as ut,k as X,p as L,r as Q,q as pt,l as vt,A as ft,D as tt,e as St}from"./client-CA75qaa4.js";class et{static tanh(t){return Math.tanh(t)}static tanhDerivative(t){const e=Math.tanh(t);return 1-e*e}static elu(t,e=1){return t>=0?t:e*(Math.exp(t)-1)}static eluDerivative(t,e=1){return t>=0?1:e*Math.exp(t)}static swish(t){return t/(1+Math.exp(-t))}static swishDerivative(t){const e=1/(1+Math.exp(-t));return e+t*e*(1-e)}static gelu(t){return .5*t*(1+Math.tanh(Math.sqrt(2/Math.PI)*(t+.044715*t*t*t)))}static geluDerivative(t){const e=Math.sqrt(2/Math.PI),o=t+.044715*t*t*t,d=Math.tanh(e*o),M=1-d*d;return .5*(1+d)+.5*t*M*e*(1+3*.044715*t*t)}static leakyRelu(t,e=.01){return t>0?t:e*t}static leakyReluDerivative(t,e=.01){return t>0?1:e}}const wt={swish:[et.swish,et.swishDerivative]};class xt{id;row;column;internalState;idealState;transitions;rotation;targetRotation;targetState;dim;isPaired;expressionModel;bias;constructor(t,e,o){this.id=t,this.row=e,this.column=o,this.internalState=Object.values(j).map(()=>Math.random()*.5-.25),this.bias=Object.values(j).map(()=>Math.random()*.2-.1),this.dim=this.internalState.length,this.transitions=new Array(this.dim).fill(0).map((d,M)=>new Array(this.dim).fill(0).map((b,p)=>Math.random()*1-.5)),this.rotation=[0,0,0],this.targetRotation=[0,0,0],this.targetState=[...this.internalState],this.isPaired=!1,this.expressionModel=new it(new nt)}interact(t,e,o){this.isPaired=!0;const[d,M]=wt.swish,b=[];for(let s=0;s<this.dim;s++){let u=this.bias[s];for(let f=0;f<this.dim;f++)u+=this.transitions[s][f]*t[f];b.push(u)}const p=b.map(s=>d(s)),_=[...this.internalState];for(let s=0;s<this.dim;s++)_[s]+=p[s];this.targetState=_.map(s=>Math.tanh(s));const E=[];let y=0;for(let s=0;s<this.dim;s++){const u=o[s]-this.targetState[s];E.push(u),y+=u*u}y/=this.dim;for(let s=0;s<this.dim;s++){const u=-2*E[s]/this.dim,f=1-Math.tanh(_[s])**2,C=1,i=M(b[s]);for(let h=0;h<this.dim;h++){const m=t[h],g=u*f*C*i*m;this.transitions[s][h]-=e*g}const a=u*f*C*i*1;this.bias[s]-=e*a}return{loss:y,errors:E,delta:p,bias:[...this.bias]}}rotate(t){this.targetRotation=[...t]}update(t){for(let e=0;e<this.rotation.length;e++)this.rotation[e]+=(this.targetRotation[e]-this.rotation[e])*t*4;for(let e=0;e<this.dim;e++)this.internalState[e]+=(this.targetState[e]-this.internalState[e])*t}getExpression(t){const e=this.expressionModel.getExpression(this.internalState.map(d=>d*t));for(var o=1;o<e.children.length;o++){const d=e.children[o];d.position.set(d.position.x+this.rotation[1]*.2,d.position.y+this.rotation[0]*.3,d.position.z-Math.abs(this.rotation[1]*.1))}return e.rotation.set(this.rotation[0],this.rotation[1],this.rotation[2]),e.position.set(this.column*5,this.row*5,0),e}faceDirection(t,e){const o=[0,0,0];t==1?o[1]=Math.PI/5:t==-1&&(o[1]=-Math.PI/5),e==-1?o[0]=Math.PI/8:e==1&&(o[0]=-Math.PI/8),this.targetRotation=o}}var Mt=at('<div id=game-container style=text-align:center;flex-direction:row;align-items:center;justify-content:center><div class="game pixelated-border"><!$><!/><div class=halftone></div><div id=loading>Loading...</div></div><div style=flex-direction:column;align-items:center;justify-content:center;width:300px><h1>Games with Emotions</h1><div id=controls><h4>Homeostasis</h4><!$><!/><!$><!/><h4>Settings</h4><div style=align-items:center><input type=range min=-14 max=0><span>Learning Rate</span></div><div style=align-items:center><input type=range min=100 max=10000><span>Animation Speed</span></div><div style=align-items:center><input type=range min=80 max=1000><span>Intensity</span></div><div style=align-items:center><input type=range min=0 max=10><span>Extroversion'),yt=at("<div style=align-items:center><input type=range min=-100 max=100><span>");let R=1,B=400;const x=Object.keys(j).reduce((r,t)=>(r[t]=Math.random()*80-40,r),{});let P=40,I=[...Object.keys(x).map(r=>x[r]/P)],V=1;const bt=r=>{const t=new ct(r.width,r.height);t.camera=new ht(-2.5*r.gridSize,2.5*r.gridSize,2.5*r.gridSize,-2.5*r.gridSize,.01,100),t.camera.position.set(2.5*(r.gridSize-1),2.5*(r.gridSize-1),10),t.camera.updateProjectionMatrix();let e=r.gridSize*1.25,o=!1;t.renderer.domElement.addEventListener("pointerdown",i=>{i.preventDefault(),o=!0,i.clientX,i.clientY}),window.addEventListener("pointerup",i=>{i.preventDefault(),o=!1}),window.addEventListener("pointercancel",i=>{i.preventDefault(),o=!1}),t.renderer.domElement.addEventListener("pointermove",i=>{if(i.preventDefault(),o){const n=(t.camera.right-t.camera.left)/t.renderer.domElement.width,a=-i.movementX*n,h=i.movementY*n;t.camera.position.x+=a,t.camera.position.y+=h}i.clientX,i.clientY}),t.renderer.domElement.addEventListener("wheel",i=>{i.preventDefault();const n=t.renderer.domElement.getBoundingClientRect(),a=(i.clientX-n.left)/n.width*2-1,h=-((i.clientY-n.top)/n.height)*2+1,m=new mt(a,h,0);m.unproject(t.camera),m.z=0;const g=i.deltaY>0?.95:1.05,v=e*g,S=m.clone();v>=20?(t.camera.top=t.camera.right=2.5*r.gridSize,t.camera.bottom=t.camera.left=-2.5*r.gridSize):(t.camera.top*=g,t.camera.bottom*=g,t.camera.left*=g,t.camera.right*=g,m.set(a,h,0),m.unproject(t.camera),m.z=0,t.camera.position.x+=S.x-m.x,t.camera.position.y+=S.y-m.y,e=v),t.camera.updateProjectionMatrix()});let d=[],M=0,b=performance.now(),p=0,_=!1;const E=new Worker(new URL("/expressions/_build/assets/AgentWorker-DVLLdq1K.js",import.meta.url),{type:"module"});E.onmessage=i=>{i.data.type==="agents-created"&&(d=i.data.agents.map(n=>{const a=new xt(n.id,n.row,n.column);return a.internalState=n.internalState,a.bias=n.bias,a.transitions=n.transitions,a.rotation=n.rotation,a.targetRotation=n.targetRotation,a.targetState=n.targetState,a.dim=n.dim,a.isPaired=n.isPaired,a}),document.getElementById("loading")?.remove(),_=!0,y())},E.postMessage({type:"init",data:{gridSize:r.gridSize}});const y=()=>{if(!_){requestAnimationFrame(y);return}if(p<=0){u();return}const i=performance.now();M=i-b,b=i;let n=Math.max(0,Math.min(1,p>0?M/p:0));for(const a of d)a.update(n);s(),p=Math.max(p-M,0),requestAnimationFrame(y)},s=()=>{t.scene.clear();const i=new ft(11141239,3),n=new tt(13408682,1);n.position.set(-2,4.5,9);const a=new tt(10070732,4);a.position.set(3,3,5),t.scene.add(i),t.scene.add(n),t.scene.add(a);for(const h of d){const m=h.getExpression(P);t.add(m)}t.render()},u=()=>{for(const a of d)a.isPaired=!1;for(var i=0;i<r.gridSize;i++)for(var n=0;n<r.gridSize;n++){const a=d[i*r.gridSize+n];if(!a.isPaired){let h=!0,m=0;for(;h&&m<V;){m++;let g=Math.round(Math.random()*2.98-1.49),v=Math.round(Math.random()*2.98-1.49);const S=Math.max(0,Math.min(r.gridSize-1,n+g)),A=Math.max(0,Math.min(r.gridSize-1,i+v));if(g=S-n,v=A-i,g==0&&v==0)continue;const $=d[A*r.gridSize+S];$&&!$.isPaired&&(a.interact($.internalState,R,I),$.interact(a.internalState,R,I),a.faceDirection(g,v),$.faceDirection(-g,-v),h=!1)}h&&(a.interact(a.internalState,R,I),a.rotate([0,0,0]))}}p=B,requestAnimationFrame(y)},[f,C]=gt(x);return(()=>{var i=J(Mt),n=i.firstChild,a=n.firstChild,[h,m]=Y(a.nextSibling);h.nextSibling;var g=n.nextSibling,v=g.firstChild,S=v.nextSibling,A=S.firstChild,$=A.nextSibling,[H,rt]=Y($.nextSibling),st=H.nextSibling,[N,ot]=Y(st.nextSibling),lt=N.nextSibling,D=lt.nextSibling,W=D.firstChild,O=D.nextSibling,K=O.firstChild,k=O.nextSibling,U=k.firstChild,T=k.nextSibling,Z=T.firstChild;return c(i,"position","relative"),c(i,"width","100%"),c(i,"height","calc(100% - 2em)"),c(i,"padding","1em"),c(i,"display","flex"),c(n,"position","relative"),F(n,()=>t.renderer.domElement,h,m),c(g,"display","flex"),F(S,G(ut,{id:"face",width:140,height:140,get expressionModel(){return r.expressionModel},get emotionLevels(){return f()}}),H,rt),F(S,G(pt,{get each(){return Object.keys(j)},children:l=>(()=>{var w=J(yt),z=w.firstChild,q=z.nextSibling;return c(w,"display","flex"),c(w,"gap","10px"),z.$$input=dt=>{x[l]=parseInt(dt.target.value),I[Object.keys(j).indexOf(l)]=x[l]/P,C({...x})},F(q,()=>String(l)),X(()=>L(z,"value",x[l])),Q(),w})()}),N,ot),c(D,"display","flex"),c(D,"gap","10px"),W.$$input=l=>{R=10**parseInt(l.target.value)},c(O,"display","flex"),c(O,"gap","10px"),K.$$input=l=>{B=10100-parseInt(l.target.value)},L(K,"value",10100-B),c(k,"display","flex"),c(k,"gap","10px"),U.$$input=l=>{P=parseInt(l.target.value),I=[...Object.keys(x).map(w=>x[w]/P)]},L(U,"value",P),c(T,"display","flex"),c(T,"gap","10px"),Z.$$input=l=>{V=parseInt(l.target.value)},L(Z,"value",V),X(l=>{var w=r.id,z=r.width+"px",q=r.height+"px";return w!==l.e&&vt(n,"id",l.e=w),z!==l.t&&c(n,"width",l.t=z),q!==l.a&&c(n,"height",l.a=q),l},{e:void 0,t:void 0,a:void 0}),X(()=>L(W,"value",Math.log10(R))),Q(),i})()};St(["input"]);const _t=()=>{const r=new nt,t=new it(r);let e=140,o=16;return G(bt,{id:"game",get width(){return Math.min(e*o,window.innerWidth*.95,window.innerHeight*.95)},get height(){return Math.min(e*o,window.innerWidth*.95,window.innerHeight*.95)},expressionModel:t,gridSize:o})};export{_t as default};
