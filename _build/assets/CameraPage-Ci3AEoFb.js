const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/face_mesh-C4n09Vz3.js","assets/_commonjsHelpers-Cpj98o6Y.js","assets/camera_utils-c8ZgCaOI.js"])))=>i.map(i=>d[i]);
import{_ as Rt,a as q,m as W,b as ce,g as rt,t as ht,d as Ot,s as f,i as G,c as ot,F as me,e as ge,r as jt,f as Wt,h as de,j as Z,k as T,u as J,n as ue,E as fe,C as pe}from"./client-jDQGuH0I.js";import{s as st,G as xe,T as Q,f as B}from"./GPU-DfCXmufw.js";const ve={silhouette:{path:[10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109],closed:!0,name:"Silhouette",description:"Starting at the top of the forehead and going clockwise, outline the face."}},ye={rightEyebrow:{path:[46,53,52,65,55],closed:!0,name:"Left eyebrow",description:"Draw a line from left to right representing the left eyebrow."},leftEyebrow:{path:[276,283,282,295,285],closed:!0,name:"Right eyebrow",description:"Draw a line from right to left representing the right eyebrow."},leftEye:{path:[263,466,388,387,386,385,384,398,362,382,381,380,374,373,390,249],closed:!0,name:"Right eye",description:"Starting at the outer right corner of the right eye, draw a counter-clockwise path that follows the outer edge of the eye."},rightEye:{path:[33,246,161,160,159,158,157,173,133,155,154,153,144,163,7],closed:!0,name:"Left eye",description:"Starting at the outer left corner of the left eye, draw a clockwise path that follows the outer edge of the eye."}},we={"outer lips":{path:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],closed:!0,name:"Lips",description:"Starting at the outer left corner of the lips, draw a clockwise path that follows the outer edge of the lips."},"inner lips":{path:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95],closed:!0,name:"Mouth",description:"Starting at the outer left corner of the mouth, draw a clockwise path that follows the outer edge of the mouth (inner edge of the lips)."}},nt={silhouette:ve,eyes:ye,mouth:we},Gt=d=>({minX:Math.floor(Math.min(...d.map(t=>t[0]))),maxX:Math.ceil(Math.max(...d.map(t=>t[0]))),minY:Math.floor(Math.min(...d.map(t=>t[1]))),maxY:Math.ceil(Math.max(...d.map(t=>t[1]))),minZ:Math.floor(Math.min(...d.map(t=>t[2]))),maxZ:Math.ceil(Math.max(...d.map(t=>t[2])))}),qt=(d,t,i)=>(t[0]-d[0])*(i[1]-d[1])-(t[1]-d[1])*(i[0]-d[0]),Vt=(d,t)=>Math.hypot(t[0]-d[0],t[1]-d[1]),be=d=>{if(d.length<3)return d;let t=0;for(let u=1;u<d.length;u++)(d[u][1]<d[t][1]||d[u][1]===d[t][1]&&d[u][0]<d[t][0])&&(t=u);const i=d[t],r=d.filter((u,M)=>M!==t).sort((u,M)=>{const h=Math.atan2(u[1]-i[1],u[0]-i[0]),o=Math.atan2(M[1]-i[1],M[0]-i[0]);return h!==o?h-o:Vt(i,u)-Vt(i,M)}),n=[i];for(const u of r){for(;n.length>1&&qt(n[n.length-2],n[n.length-1],u)<=0;)n.pop();n.push(u)}return n},Se=(d,t)=>{if(t.length<3)return!1;for(let i=0;i<t.length;i++){const r=t[i],n=t[(i+1)%t.length];if(qt(r,n,d)<0)return!1}return!0};class ke{imageLandmarks;cameraLandmarks;baseTransform;imagePoints;cameraPoints;imageBBox;cameraBBox;nilpotentTPS;baseTPS;activeTPS;canvas;ctx;hull;silhouetteHull;imageSilhouette;mask;forwardMap;inverseMap;offscreenCanvas;offscreenCtx;processingScale;imageData;landmarkSkip;blurMask;gpu;constructor(t,i,r,n=2){this.imageLandmarks=t,this.cameraLandmarks=i,this.imagePoints=[],this.cameraPoints=[],this.imageData=r,this.landmarkSkip=2,this.silhouetteHull=[];for(let h=0;h<st.path.length;h++)this.silhouetteHull.push([i[st.path[h]][0],i[st.path[h]][1]]);for(const[h,o]of t){const w=parseInt(h);w<i.length?(this.imagePoints.push(o.slice(0,2)),this.cameraPoints.push([i[w][0],i[w][1]])):console.log("Image landmark index out of bounds:",w)}this.gpu=new xe,this.baseTPS=new Q(this.cameraPoints,this.imagePoints),console.log(this.baseTPS),this.nilpotentTPS=new Q(this.cameraLandmarks.filter((h,o)=>o%this.landmarkSkip===0).map(h=>h.slice(0,2)),this.cameraLandmarks.filter((h,o)=>o%this.landmarkSkip===0).map(h=>h.slice(0,2))),this.activeTPS=this.nilpotentTPS,this.imageSilhouette=[];for(let h=0;h<this.silhouetteHull.length;h++)this.imageSilhouette.push(this.baseTPS.forward(this.silhouetteHull[h]));this.imageBBox=Gt(this.imageSilhouette),console.log(this.imageBBox),this.cameraBBox=Gt(this.silhouetteHull),this.inverseMap=this.precomputeTransformationMap(this.baseTPS),this.canvas=document.createElement("canvas"),this.canvas.width=this.imageBBox.maxX-this.imageBBox.minX,this.canvas.height=this.imageBBox.maxY-this.imageBBox.minY,this.canvas.style.position="absolute",this.canvas.style.top=this.imageBBox.minY+"px",this.canvas.style.left=this.imageBBox.minX+"px",this.canvas.style.pointerEvents="none",this.canvas.style.background="transparent",this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=new OffscreenCanvas(this.canvas.width/n,this.canvas.height/n),this.processingScale=n,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.offscreenCtx.fillRect(0,0,this.canvas.width/this.processingScale,this.canvas.height/this.processingScale),this.ctx.fillStyle="transparent",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.hull=be(this.imageSilhouette),this.mask=new Uint8ClampedArray(this.canvas.width*this.canvas.height);for(let h=0;h<this.canvas.height;h++)for(let o=0;o<this.canvas.width;o++)this.mask[h*this.canvas.width+o]=Se([o+this.imageBBox.minX,h+this.imageBBox.minY],this.hull)?255:0;let u=new Uint8ClampedArray([...this.mask]);this.blurMask=new Uint8Array(this.canvas.width*this.canvas.height);const M=20;for(let h=0;h<M;h++){for(let o=0;o<this.canvas.height;o++)for(let w=0;w<this.canvas.width;w++){this.blurMask[o*this.canvas.width+w]=0;for(let $=-1;$<=1;$++)for(let _=-1;_<=1;_++){const k=o+$,Y=w+_;k<0||k>=this.canvas.height||Y<0||Y>=this.canvas.width||(this.blurMask[o*this.canvas.width+w]+=u[k*this.canvas.width+Y]*Math.pow(.5,2+Math.abs($)+Math.abs(_)))}}u=new Uint8ClampedArray([...this.blurMask])}return console.log(this.blurMask),this.gpu.initialize().then(()=>{console.log("GPU initialized successfully"),this.gpu.createBuffers({baseNumPoints:this.cameraPoints.length,distortNumPoints:this.cameraLandmarks.filter((o,w)=>w%this.landmarkSkip===0).length,imageWidth:this.imageData.width,imageHeight:this.imageData.height,faceMinY:this.imageBBox.minY,faceMinX:this.imageBBox.minX,faceWidth:this.imageBBox.maxX-this.imageBBox.minX,faceHeight:this.imageBBox.maxY-this.imageBBox.minY}),this.gpu.updateBuffer(this.gpu.meshPointsBuffer,new Float32Array(this.cameraPoints.map(o=>o.slice(0,2)).flat())),this.gpu.updateBuffer(this.gpu.imagePointsBuffer,new Float32Array(this.imagePoints.map(o=>o.slice(0,2)).flat())),this.gpu.updateBuffer(this.gpu.distortPointsBuffer,new Float32Array(this.cameraLandmarks.filter((o,w)=>w%this.landmarkSkip===0).map(o=>o.slice(0,2)).flat())),this.gpu.updateBuffer(this.gpu.modelPointsBuffer,new Float32Array(this.cameraLandmarks.filter((o,w)=>w%this.landmarkSkip===0).map(o=>o.slice(0,2)).flat())),console.log(this.baseTPS.inverseParameters.Xc,this.baseTPS.inverseParameters.Yc,this.baseTPS.forwardParameters.Xc,this.baseTPS.forwardParameters.Yc),this.gpu.updateBaseCoeffs(this.baseTPS.inverseParameters.Xc,this.baseTPS.inverseParameters.Yc,this.baseTPS.forwardParameters.Xc,this.baseTPS.forwardParameters.Yc),this.gpu.updateCombinedCoeffs(this.gpu.model2distortCoeffsBuffer,this.activeTPS.inverseParameters.Xc,this.activeTPS.inverseParameters.Yc);const h=new Uint32Array(this.imageData.data.length/4);for(let o=0;o<this.imageData.data.length;o+=4)h[o/4]=this.imageData.data[o+3]<<24|this.imageData.data[o+2]<<16|this.imageData.data[o+1]<<8|this.imageData.data[o];this.gpu.updateUintBuffer(this.gpu.imageDataBuffer,h),this.gpu.updateFaceDataWithBlurMask(this.blurMask),this.gpu.updateUniforms({baseNumPoints:this.cameraPoints.length,distortNumPoints:this.cameraLandmarks.filter((o,w)=>w%this.landmarkSkip===0).length,imageWidth:this.imageData.width,imageHeight:this.imageData.height,faceMinY:this.imageBBox.minY,faceMinX:this.imageBBox.minX,faceWidth:this.imageBBox.maxX-this.imageBBox.minX,faceHeight:this.imageBBox.maxY-this.imageBBox.minY}),console.log("GPU buffers initialized successfully")}).catch(h=>{console.error("Failed to initialize GPU:",h)}),this}precomputeTransformationMap(t){const i=[];for(let r=this.imageBBox.minY;r<this.imageBBox.maxY;r++)for(let n=this.imageBBox.minX;n<this.imageBBox.maxX;n++){const u=t.inverse([n,r,0]);i.push(u)}return i}updateActiveTPS(t){return t.length!=this.cameraLandmarks.length?!1:(this.activeTPS=new Q(this.cameraLandmarks.filter((i,r)=>r%this.landmarkSkip===0).map(i=>i.slice(0,2)),t.filter((i,r)=>r%this.landmarkSkip===0).map(i=>i.slice(0,2))),!0)}updateActiveTargets(t){const i=this.activeTPS.updateInverseParameters(t.filter((r,n)=>n%this.landmarkSkip===0).map(r=>r.slice(0,2)));return i&&this.gpu.initialized&&(this.gpu.updateBuffer(this.gpu.distortPointsBuffer,new Float32Array(t.filter((r,n)=>n%this.landmarkSkip===0).map(r=>r.slice(0,2)).flat())),this.gpu.updateCombinedCoeffs(this.gpu.model2distortCoeffsBuffer,new Float32Array(i.Xc),new Float32Array(i.Yc))),!0}transformXY(t,i){const r=this.inverseMap[(i-this.imageBBox.minY)*(this.imageBBox.maxX-this.imageBBox.minX)+t-this.imageBBox.minX];return this.baseTPS.forward(this.activeTPS.inverse(r))}draw(){const t=Math.floor(this.canvas.width/this.processingScale),i=Math.floor(this.canvas.height/this.processingScale),r=new Uint8ClampedArray(t*i*4).fill(0);let n=0;for(let u=0;u<this.canvas.height;u+=this.processingScale){let M=0;for(let h=0;h<this.canvas.width;h+=this.processingScale){const o=this.blurMask[u*this.canvas.width+h];if(o===0){M++;continue}const w=(n*t+M)*4,[$,_]=[h+this.imageBBox.minX,u+this.imageBBox.minY],[k,Y]=this.transformXY($,_),[z,x]=[k,Y],p=o/255,[v,U]=[$+p*(z-$),_+p*(x-_)],F=(Math.round(U)*this.imageData.width+Math.round(v))*4;F>=0&&F<this.imageData.data.length-3&&Math.round(v)>=0&&Math.round(v)<this.imageData.width&&Math.round(U)>=0&&Math.round(U)<this.imageData.height&&(r[w]=this.imageData.data[F],r[w+1]=this.imageData.data[F+1],r[w+2]=this.imageData.data[F+2],r[w+3]=this.imageData.data[F+3]),M++}n++}this.offscreenCtx.putImageData(new ImageData(r,t,i),0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height)}drawGPU(){if(!this.gpu.initialized){console.log("GPU not ready, falling back to CPU"),this.draw();return}const t=this.imageBBox.maxX-this.imageBBox.minX,i=this.imageBBox.maxY-this.imageBBox.minY;this.gpu.updateUniforms({baseNumPoints:this.cameraPoints.length,distortNumPoints:this.cameraLandmarks.filter((r,n)=>n%this.landmarkSkip===0).length,imageWidth:this.imageData.width,imageHeight:this.imageData.height,faceMinY:this.imageBBox.minY,faceMinX:this.imageBBox.minX,faceWidth:t,faceHeight:i}),this.gpu.execute(t,i).then(()=>{this.gpu.readBuffer(this.gpu.faceDataBuffer,t*i*4).then(r=>{const n=new ImageData(r,t,i);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreenCtx.putImageData(n,0,0),this.ctx.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height),this.gpu.updateFaceDataWithBlurMask(this.blurMask)}).catch(r=>{console.error("Error reading GPU buffer:",r),this.draw()})}).catch(r=>{console.error("Error executing GPU shader:",r),this.draw()})}destroy(){this.gpu&&this.gpu.destroy(),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}}class Pe{faceMesh;camera;videoElement;onLandmarksCallback;isInitialized=!1;smoothedLandmarks=null;smoothingFactor=.3;constructor(t,i=.3){this.onLandmarksCallback=t,this.smoothingFactor=Math.max(0,Math.min(1,i)),this.videoElement=document.createElement("video"),this.initializeMediaPipe()}async initializeMediaPipe(){try{const[{FaceMesh:t},{Camera:i}]=await Promise.all([Rt(()=>import("./face_mesh-C4n09Vz3.js").then(r=>r.f),__vite__mapDeps([0,1])),Rt(()=>import("./camera_utils-c8ZgCaOI.js").then(r=>r.c),__vite__mapDeps([2,1]))]);this.faceMesh=new t({locateFile:r=>`../node_modules/@mediapipe/face_mesh/${r}`}),this.faceMesh.setOptions({maxNumFaces:1,refineLandmarks:!0}),this.faceMesh.onResults(r=>{if(r.multiFaceLandmarks&&this.onLandmarksCallback){const n=this.regularizeLandmarks(r.multiFaceLandmarks[0]);this.onLandmarksCallback(n)}}),this.camera=new i(this.videoElement,{onFrame:async()=>{await this.faceMesh.send({image:this.videoElement})},width:640,height:480,facingMode:"user"}),this.isInitialized=!0}catch(t){console.error("Failed to initialize MediaPipe:",t)}}regularizeLandmarks(t,i=1){if(!t)return[];const r={x:t.reduce((x,p)=>x+p.x,0)/t.length,y:t.reduce((x,p)=>x+p.y,0)/t.length,z:t.reduce((x,p)=>x+p.z,0)/t.length};let n=t.map(x=>({x:x.x,y:x.y,z:x.z}));n=n.map(x=>({x:x.x-r.x,y:x.y-r.y,z:x.z-r.z}));const M=n[233],h=n[453],o={x:h.x-M.x,y:h.y-M.y,z:h.z-M.z},w=Math.atan2(o.z,o.x);n=n.map(x=>{const p=Math.cos(-w),v=Math.sin(-w);return{x:x.x*p-x.z*v,y:x.y,z:x.x*v+x.z*p}});const _=n.map(x=>x.y),Y=2e4/(Math.max(..._)-Math.min(..._));let z=n.map(x=>[x.x*Y*i,-x.y*Y*i,x.z*Y*i]);return z=this.applyTemporalSmoothing(z),z}applyTemporalSmoothing(t){if(!this.smoothedLandmarks)return this.smoothedLandmarks=t.map(r=>[...r]),this.smoothedLandmarks;const i=t.map((r,n)=>{const u=this.smoothedLandmarks[n];return[u[0]+this.smoothingFactor*(r[0]-u[0]),u[1]+this.smoothingFactor*(r[1]-u[1]),u[2]+this.smoothingFactor*(r[2]-u[2])]});return this.smoothedLandmarks=i,i}setSmoothingFactor(t){this.smoothingFactor=Math.max(0,Math.min(1,t))}resetSmoothing(){this.smoothedLandmarks=null}start(){if(!this.isInitialized)throw new Error("MediaPipe components are not initialized. Call initializeMediaPipe() first.");return this.camera.start()}stop(){if(!this.isInitialized)throw new Error("MediaPipe components are not initialized. Call initializeMediaPipe() first.");this.camera.stop()}setOnLandmarksCallback(t){this.onLandmarksCallback=t}}var Be=ht('<div id=pareidolia style=flex-direction:row;align-items:center;justify-content:center><div style="flex-direction:column;align-items:center;justify-content:center;transform-origin:center center;flex-grow:3;flex-shrink:0"><div style=font-size:16px;pointer-events:none;z-index:1000>Drop an image here</div><canvas id=source></canvas><svg id=landmarks xmlns=http://www.w3.org/2000/svg style=stroke:blue;fill:rgba(255,255,255,0.4)></svg></div><div style=flex-direction:column;align-items:center;justify-content:center;width:300px><h1>Pareidolia</h1><div id=controls><div><!$><!/><svg id=face-svg width=140 height=140></svg></div><h4>Layers</h4><div id=layers><input type=button value=Mask><!$><!/><input type=button value=Basics></div><h4></h4><div></div><input type=button value=Back><input type=button value=Skip><input type=button value=Next><br><input type=button value="Do it!"><h4>Camera</h4><input type=button value=Start><input type=button value=Stop><br><input type=button value="View Points">'),Me=ht("<input type=button>");const K=0,$e=d=>{let t,i,r,n,u,M,h;const[o,w]=q(!1),[$,_]=q({width:600,height:600}),[k,Y]=q(1),[z,x]=q("Upload an Image"),p={points:[]};let v=0,U;const F=1;let lt=null,O="feature",H="basics";const ct=s=>{const e=$().width,l=$().height,a=s.filter((D,I)=>I%3===0),c=s.filter((D,I)=>I%3===1),m=Math.min(...a),S=Math.min(...c),y=Math.max(...a),b=Math.max(...c),P=(e-2*K)/(y-m),A=(l-2*K)/(b-S);return s.map((D,I)=>I%3===0?(D-m)*P+K:I%3===1?l-((D-S)*A+K):D)};ct(T.vertices);let C=null;const mt=new Pe(async s=>{if(s.length>0&&!t){t=s;return}!C||!s||C.updateActiveTargets(s)&&requestAnimationFrame(()=>{try{C.drawGPU(),console.log("GPU")}catch{C.draw(),console.log("CPU fallback")}})});let j=()=>{},V=[],tt=!1;const R=()=>{const s=[],e=[];if(O=="feature"){ft=performance.now();for(const a in p){let c=0;for(const m of p[a]){if(!m){c++;continue}a!="points"&&(p.points[B[a].path[c]]={x:m.x,y:m.y,index:B[a].path[c]}),c++}}}for(const a of p.points)a&&(s.push([a.x,a.y,0]),e.push([T.vertices[a.index*3],T.vertices[a.index*3+1],T.vertices[a.index*3+2]]));console.log(p),s.length>5&&!tt?(O="points",tt=!0,requestAnimationFrame(()=>{lt=new Q(s,e),V=[];for(var a=0;a<T.vertices.length;a+=3){const c=[T.vertices[a],T.vertices[a+1],T.vertices[a+2]];V.push(lt.inverse(c))}it(),tt=!1})):j();const l=Object.keys(B)[v];x(l)},Zt=async()=>{j(),C&&C.destroy();const s=new Map;for(const e of p.points)e&&s.set(e.index,[e.x,e.y,0]);C=new ke(s,t,U,F),C.canvas.style.position="absolute",C.canvas.style.top="50%",C.canvas.style.left="50%",C.canvas.style.transform=`translate(${-i.getBoundingClientRect().width/(2*k())}px, ${-i.getBoundingClientRect().height/(2*k())}px) translate(${C.imageBBox.minX}px, ${C.imageBBox.minY}px)`,C.canvas.style.pointerEvents="none",i.after(C.canvas)},Jt=Math.max(...W.filter((s,e)=>e%3===0)),gt=Math.min(...W.filter((s,e)=>e%3===0)),Kt=Math.max(...W.filter((s,e)=>e%3===1)),dt=Math.min(...W.filter((s,e)=>e%3===1)),ut=140,et=s=>{const e=W.slice(s*3,s*3+3),l=[];return l.push((e[0]-gt)/(Jt-gt)*96+22),l.push((e[1]-dt)/(Kt-dt)*112+12),l},E=document.createElementNS("http://www.w3.org/2000/svg","line");E.style.stroke="cyan",E.style.fill="none",E.style.strokeWidth="3";let ft=performance.now();const pt=()=>{if(!h)return;if(v>=3){h.innerHTML="";return}let s=Object.keys(B)[v];console.log(v,s,Object.keys(B));const e=et(B[s].path[0]),l=et(B[s].path[1]),a=(performance.now()-ft)%(1e3*Math.PI),c=.5*(1+Math.cos(a/1e3)),m=[e[0]*c+l[0]*(1-c),e[1]*c+l[1]*(1-c)];E.setAttribute("x1",e[0].toString()),E.setAttribute("y1",e[1].toString()),E.setAttribute("x2",m[0].toString()),E.setAttribute("y2",m[1].toString()),h.appendChild(E),requestAnimationFrame(pt)},xt=s=>{if(!h)return;const e=parseInt(s.getAttribute("index")),l=et(e);console.log(l);const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",l[0].toString()),a.setAttribute("cy",l[1].toString()),a.setAttribute("r","2"),a.style.stroke="black",a.style.fill="white",h.appendChild(a)},vt=()=>{h&&(h.innerHTML="")};let X=null;const Qt=s=>{s.onmousedown=e=>{e.preventDefault(),e.stopPropagation(),X=s,xt(s)},s.onmouseenter=e=>{e.preventDefault(),e.stopPropagation(),xt(s)},s.onmouseleave=e=>{e.preventDefault(),e.stopPropagation(),vt()}},it=(s=!1)=>{if(!n)return;s&&j();const e=[];for(const a in nt[H])e.push(...nt[H][a].path);console.log(e);for(var l=0;l<V.length;l++){if(!e.includes(l))continue;const a=V[l],c=document.getElementById("point-"+l);if(c)l in p.points&&(c.setAttribute("r",(2/k()).toString()),c.style.stroke="blue",c.style.fill="blue"),c.setAttribute("cx",a[0].toString()),c.setAttribute("cy",a[1].toString());else{const m=document.createElementNS("http://www.w3.org/2000/svg","circle");m.setAttribute("cx",a[0].toString()),m.setAttribute("cy",a[1].toString()),m.setAttribute("id","point-"+l),m.setAttribute("index",l.toString()),m.style.stroke="red",m.style.fill="red",m.setAttribute("r",(.5/k()).toString()),l in p.points&&(m.setAttribute("r",(2/k()).toString()),m.style.stroke="blue",m.style.fill="blue",m.style.strokeWidth="1"),Qt(m),n.appendChild(m)}}},te=(s,e)=>{const a=window.innerHeight*.8;return Math.min(a/e,1)},ee=s=>{s.preventDefault(),s.stopPropagation()},ie=s=>{s.preventDefault(),s.stopPropagation();const e=s.dataTransfer?.files;if(!e||e.length===0)return;const l=e[0];if(!l.type.startsWith("image/")){alert("Please drop an image file");return}const a=new FileReader;a.onload=c=>{const m=new Image;m.onload=()=>{const y=Math.min(1,640/m.width,640/m.height),b=m.width*y,P=m.height*y;_({width:b,height:P});const A=te(b,P);Y(A),i&&(i.width=b,i.height=P,r=i.getContext("2d"),r?.drawImage(m,0,0,b,P)),n&&(n.setAttribute("width",b.toString()),n.setAttribute("height",P.toString())),U=r.getImageData(0,0,b,P),w(!0),ct(T.vertices),R(),pt()},m.src=c.target?.result},a.readAsDataURL(l)};return ce(()=>{if(!i||!n||(r=i.getContext("2d"),!o()))return;let s=!1,e={x:0,y:0};const l=document.createElementNS("http://www.w3.org/2000/svg","circle");l.setAttribute("cx",e.x.toString()),l.setAttribute("cy",e.y.toString()),l.setAttribute("r",(5/k()).toString()),l.style.stroke="red",l.style.fill="red";const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",e.x.toString()),a.setAttribute("y1",e.y.toString()),a.setAttribute("x2",e.x.toString()),a.setAttribute("y2",e.y.toString()),a.style.stroke="red",a.style.fill="red";const c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("d",`M ${e.x} ${e.y} L ${e.x} ${e.y}`),c.style.stroke="red",c.style.fill="rgba(255,0,0,0.2)";const m=S=>{const y=n.getBoundingClientRect(),b=(S.clientX-y.left)/k(),P=(S.clientY-y.top)/k();return{x:b,y:P}};j=()=>{l.remove(),a.remove(),c.remove()},n.onmousedown=S=>{if(v==null||X||O=="points")return;const y=Object.keys(B)[v];S.preventDefault(),S.stopPropagation();const{x:b,y:P}=m(S);s=!0,e={x:b,y:P},p[y]=[],B[y].path.length==1?(l.setAttribute("cx",b.toString()),l.setAttribute("cy",P.toString()),n.appendChild(l)):B[y].path.length==2?(p[y].push(e),a.setAttribute("x1",e.x.toString()),a.setAttribute("y1",e.y.toString()),a.setAttribute("x2",e.x.toString()),a.setAttribute("y2",e.y.toString()),n.appendChild(a)):(p[y].push(e),c.setAttribute("d","M "+p[y].map((A,N)=>`${A.x} ${A.y}`).join(" L ")),n.appendChild(c))},n.onmousemove=S=>{if(v==null)return;if(X){S.preventDefault(),S.stopPropagation();const b=n.getBoundingClientRect(),P=(S.clientX-b.left)/k(),A=(S.clientY-b.top)/k();X.setAttribute("cx",P.toString()),X.setAttribute("cy",A.toString());const N=parseInt(X.getAttribute("index"));p.points[N]={x:P,y:A,index:parseInt(X.getAttribute("index"))},R();return}if(O=="points")return;const y=Object.keys(B)[v];if(S.preventDefault(),S.stopPropagation(),s){const{x:b,y:P}=m(S);B[y].path.length==1?(l.setAttribute("cx",b.toString()),l.setAttribute("cy",P.toString())):B[y].path.length==2?(a.setAttribute("x2",b.toString()),a.setAttribute("y2",P.toString())):(p[y].push({x:b,y:P}),c.setAttribute("d","M "+p[y].map((A,N)=>`${A.x} ${A.y}`).join(" L ")))}},n.onmouseup=S=>{if(v==null)return;if(X||O=="points"){S.preventDefault(),S.stopPropagation(),X=null,vt();return}const y=Object.keys(B)[v];S.preventDefault(),S.stopPropagation(),s=!1;const{x:b,y:P}=m(S);B[y].path.length==1?p[y].push(e):B[y].path.length==2?p[y].push({x:b,y:P}):(p[y].push({x:b,y:P}),p[y].push({x:e.x,y:e.y}),c.setAttribute("d","M "+p[y].map((A,N)=>`${A.x} ${A.y}`).join(" L "))),v++,v=Math.min(v,Object.keys(B).length),H=="basics"&&v>2&&(H="silhouette"),R(),j()}}),(()=>{var s=rt(Be),e=s.firstChild,l=e.firstChild,a=l.nextSibling,c=a.nextSibling,m=e.nextSibling,S=m.firstChild,y=S.nextSibling,b=y.firstChild,P=b.firstChild,[A,N]=Ot(P.nextSibling),D=A.nextSibling,I=b.nextSibling,at=I.nextSibling,yt=at.firstChild,ae=yt.nextSibling,[wt,se]=Ot(ae.nextSibling),ne=wt.nextSibling,bt=at.nextSibling,St=bt.nextSibling,kt=St.nextSibling,Pt=kt.nextSibling,Bt=Pt.nextSibling,re=Bt.nextSibling,Mt=re.nextSibling,oe=Mt.nextSibling,$t=oe.nextSibling,At=$t.nextSibling,he=At.nextSibling,le=he.nextSibling;s.addEventListener("drop",ie),s.addEventListener("dragover",ee);var Ct=u;typeof Ct=="function"?J(Ct,s):u=s,f(s,"position","relative"),f(s,"display","flex"),f(s,"border","2px dashed #ccc"),f(s,"padding","10px"),f(s,"width","100vw"),f(s,"height","100vh"),f(s,"background","rgba(255,0,0,.1)"),f(e,"position","relative"),f(e,"display","flex"),f(l,"position","absolute"),f(l,"top","50%"),f(l,"left","50%"),f(l,"transform","translate(-50%, -50%)"),f(l,"color","#999"),f(l,"background","white");var _t=i;typeof _t=="function"?J(_t,a):i=a,f(a,"display","block");var Dt=n;typeof Dt=="function"?J(Dt,c):n=c,f(c,"position","absolute"),f(c,"top","50%"),f(c,"left","50%"),f(c,"transform","translate(-50%, -50%)"),f(c,"filter","invert(1)"),f(m,"display","flex"),f(b,"position","relative"),G(b,ot(me,{id:"face",ref(g){var L=M;typeof L=="function"?L(g):M=g},width:ut,height:ut}),A,N);var Lt=h;return typeof Lt=="function"?J(Lt,D):h=D,f(D,"position","absolute"),f(D,"top","50%"),f(D,"left","50%"),f(D,"transform","translate(-50%, -50%)"),yt.$$click=()=>{H="mask"},G(at,()=>Object.keys(nt).map(g=>(()=>{var L=rt(Me);return L.$$click=()=>{H=g,it(!0)},ge(L,"value",g),jt(),L})()),wt,se),ne.$$click=()=>{H="basics"},G(bt,(()=>{var g=Wt(()=>z()in B);return()=>g()?B[z()].name:"Upload an Image"})()),G(St,(()=>{var g=Wt(()=>z()in B);return()=>g()?B[z()].description:"Drag and drop an image to get started."})()),kt.$$click=()=>{v=Math.max(0,v-1),R()},Pt.$$click=()=>{p[z()]=[],v++,v>=Object.keys(B).length&&(v=0),R()},Bt.$$click=()=>{v++,v>=Object.keys(B).length&&(v=0),R()},Mt.$$click=()=>{Zt()},$t.$$click=()=>{mt.start().catch(g=>{console.error("Failed to start camera:",g)})},At.$$click=()=>{mt.stop()},le.$$click=g=>{const L=g.target;n.children.length>0?(n.innerHTML="",L.value="View Points"):(it(),L.value="Hide Points")},de(g=>{var L=`scale(${k()})`,Yt=o()?$().width*k()+"px":"auto",zt=o()?$().height*k()+"px":"auto",Xt=o()?"none":"block",Tt=$().width,Ft=$().height,Et=o()?`${-.5/k()}em ${.5/k()}em 0 rgba(0,0,0,.5), ${-1/k()}em ${1/k()}em 0 gray`:"none",It=$().width,Ht=$().height,Nt=o()?"auto":"none",Ut=`${5/k()}px`;return L!==g.e&&f(e,"transform",g.e=L),Yt!==g.t&&f(e,"width",g.t=Yt),zt!==g.a&&f(e,"height",g.a=zt),Xt!==g.o&&f(l,"display",g.o=Xt),Tt!==g.i&&Z(a,"width",g.i=Tt),Ft!==g.n&&Z(a,"height",g.n=Ft),Et!==g.s&&f(a,"box-shadow",g.s=Et),It!==g.h&&Z(c,"width",g.h=It),Ht!==g.r&&Z(c,"height",g.r=Ht),Nt!==g.d&&f(c,"pointer-events",g.d=Nt),Ut!==g.l&&f(c,"stroke-width",g.l=Ut),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0}),jt(),s})()};ue(["click"]);var Ae=ht("<div>");const De=()=>(new fe,(()=>{var d=rt(Ae);return f(d,"width","100vw"),f(d,"height","100vh"),G(d,ot(pe,{get children(){return ot($e,{})}})),d})());export{De as default};
