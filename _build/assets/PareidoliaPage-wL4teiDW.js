import{a as V,N as H,g as L,t as T,d as it,s as m,i as D,c as Z,o as $t,F as bt,h as dt,e as St,r as U,p as Pt,n as ft,m as A,b as Bt,f as ct,j as tt,k as mt,E as rt,u as st,C as kt}from"./client-CMB3D6Oh.js";import{s as et,T as ot,f as w}from"./TPS-DfqRdrRt.js";var Mt=T("<div style=flex-direction:column;align-items:center;justify-content:center;width:300px><h1 class=pixelated-text></h1><div id=controls class=pixelated-border><h4>Expression</h4><!$><!/><!$><!/><input type=button value=Reset><!$><!/>"),Et=T("<div id=emotion-sliders style=align-items:center><input type=range min=-100 max=100><span>");const _t=o=>{const[t,h]=V(H);return(()=>{var l=L(Mt),g=l.firstChild,n=g.nextSibling,u=n.firstChild,x=u.nextSibling,[B,at]=it(x.nextSibling),_=B.nextSibling,[q,X]=it(_.nextSibling),J=q.nextSibling,y=J.nextSibling,[b,Y]=it(y.nextSibling);return m(l,"display","flex"),D(g,()=>o.title),D(n,Z(bt,{id:"face",width:140,height:140,get expressionModel(){return new $t(o.emotionModel)},emotionLevels:t}),B,at),D(n,Z(Pt,{get each(){return Object.keys(H)},children:C=>(()=>{var j=L(Et),F=j.firstChild,p=F.nextSibling;return m(j,"display","flex"),m(j,"gap","10px"),F.$$input=W=>{const K={...t(),[C]:parseInt(W.target.value)};h(K),o.callback(K)},D(p,()=>String(C)),dt(()=>St(F,"value",t()[C])),U(),j})()}),q,X),J.$$click=()=>{h(H),document.querySelectorAll("#emotion-sliders input[type='range']").forEach(C=>{C.value="0"}),o.callback(H)},D(n,()=>o.children,b,Y),U(),l})()};ft(["click","input"]);const gt=o=>({minX:Math.floor(Math.min(...o.map(t=>t[0]))),maxX:Math.ceil(Math.max(...o.map(t=>t[0]))),minY:Math.floor(Math.min(...o.map(t=>t[1]))),maxY:Math.ceil(Math.max(...o.map(t=>t[1]))),minZ:Math.floor(Math.min(...o.map(t=>t[2]))),maxZ:Math.ceil(Math.max(...o.map(t=>t[2])))}),pt=(o,t,h)=>(t[0]-o[0])*(h[1]-o[1])-(t[1]-o[1])*(h[0]-o[0]),ut=(o,t)=>Math.hypot(t[0]-o[0],t[1]-o[1]),At=o=>{if(o.length<3)return o;let t=0;for(let n=1;n<o.length;n++)(o[n][1]<o[t][1]||o[n][1]===o[t][1]&&o[n][0]<o[t][0])&&(t=n);const h=o[t],l=o.filter((n,u)=>u!==t).sort((n,u)=>{const x=Math.atan2(n[1]-h[1],n[0]-h[0]),B=Math.atan2(u[1]-h[1],u[0]-h[0]);return x!==B?x-B:ut(h,n)-ut(h,u)}),g=[h];for(const n of l){for(;g.length>1&&pt(g[g.length-2],g[g.length-1],n)<=0;)g.pop();g.push(n)}return g},Lt=(o,t)=>{if(t.length<3)return!1;for(let h=0;h<t.length;h++){const l=t[h],g=t[(h+1)%t.length];if(pt(l,g,o)<0)return!1}return!0};class Tt{imageLandmarks;emotionModel;emotionTransforms;baseTransform;imagePoints;modelPoints;imageBBox;modelBBox;nilpotentTPS;baseTPS;baseEmotionLevels;canvas;ctx;hull;silhouetteHull;imageSilhouette;mask;constructor(t,h,l){this.emotionModel=l,this.imageLandmarks=t,this.imagePoints=[],this.modelPoints=[],this.silhouetteHull=[];for(let n=0;n<et.path.length;n++)this.silhouetteHull.push([A[et.path[n]*3],-A[et.path[n]*3+1],A[et.path[n]*3+2]]);this.baseEmotionLevels={...H,...h};const g=l.calculateCompositeEmotion(this.baseEmotionLevels);for(const[n,u]of t){this.imagePoints.push([...u]);const x=parseInt(n);this.modelPoints.push([g[x*3]+A[x*3],g[x*3+1]-A[x*3+1],g[x*3+2]+A[x*3+2]])}this.emotionTransforms=[],this.emotionModel=l,this.baseTPS=new ot(this.modelPoints,this.imagePoints),this.nilpotentTPS=new ot(this.imagePoints,this.imagePoints),this.imageSilhouette=[];for(let n=0;n<this.silhouetteHull.length;n++)this.imageSilhouette.push(this.baseTPS.forward(this.silhouetteHull[n]));console.log("imageSilhouette",this.imageSilhouette,this.silhouetteHull),this.imageBBox=gt(this.imageSilhouette),this.modelBBox=gt(this.silhouetteHull),this.baseTransform=this.precomputeTransformationMaps(this.nilpotentTPS),Object.keys(H).forEach(n=>{this.emotionTransforms[n]=this.getEmotionTransform({[n]:100})}),console.log("emotionTransforms",this.emotionTransforms),this.canvas=document.createElement("canvas"),this.canvas.width=this.imageBBox.maxX-this.imageBBox.minX,this.canvas.height=this.imageBBox.maxY-this.imageBBox.minY,this.canvas.style.position="absolute",this.canvas.style.top=this.imageBBox.minY+"px",this.canvas.style.left=this.imageBBox.minX+"px",this.canvas.style.pointerEvents="none",this.canvas.style.background="transparent",this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="transparent",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.hull=At(this.imageSilhouette),this.mask=new Uint8ClampedArray(this.canvas.width*this.canvas.height);for(let n=0;n<this.canvas.height;n++)for(let u=0;u<this.canvas.width;u++)this.mask[n*this.canvas.width+u]=Lt([u+this.imageBBox.minX,n+this.imageBBox.minY],this.hull)?255:0;return this}getEmotionTransform(t){let h=[];const l=this.emotionModel.calculateCompositeEmotion(t);for(const[n,u]of this.imageLandmarks){const x=parseInt(n);h.push([l[x*3]+A[x*3],l[x*3+1]-A[x*3+1],l[x*3+2]+A[x*3+2]])}const g=new ot(this.modelPoints,h);return this.precomputeTransformationMaps(g)}precomputeTransformationMaps(t){const h=new Map;for(let l=this.imageBBox.minY;l<this.imageBBox.maxY;l++)for(let g=this.imageBBox.minX;g<this.imageBBox.maxX;g++){const n=`${g},${l}`,u=this.baseTPS.forward(t.forward(this.baseTPS.inverse([g,l,0])));h.set(n,u)}return h}transformXY(t,h,l){let g=h*100,n=l*100,u=100;for(const x in t){if(t[x]==0)continue;const B=this.emotionTransforms[x].get(`${h},${l}`);g+=t[x]*B[0],n+=t[x]*B[1],u+=t[x]}return[g/u,n/u]}}var Ct=T("<h4>"),Dt=T("<div>"),jt=T("<input type=button value=Back>"),It=T("<input type=button value=Skip>"),Nt=T("<input type=button value=Next>"),Ht=T("<br>"),Xt=T('<input type=button value="Do it!">'),Yt=T('<div id=pareidolia style=flex-direction:row;align-items:center;justify-content:center><div style="flex-direction:column;align-items:center;justify-content:center;transform-origin:center center;flex-grow:3;flex-shrink:0"><div style=font-size:16px;pointer-events:none;z-index:1000>Drop an image here</div><canvas id=source></canvas><svg id=landmarks xmlns=http://www.w3.org/2000/svg style=stroke:blue;fill:rgba(255,255,255,0.4)></svg></div><!$><!/>');const nt=0,Ot=o=>{let t,h,l,g;const{emotionModel:n}=o,[u,x]=V(!1),[B,at]=V({width:600,height:600}),[_,q]=V(1),[X,J]=V("Upload an Image"),y={};let b=0,Y,C=H,j=H;const F=s=>{const a=B().width,i=B().height,r=s.filter((f,k)=>k%3===0),d=s.filter((f,k)=>k%3===1),P=Math.min(...r),v=Math.min(...d),c=Math.max(...r),S=Math.max(...d),$=(a-2*nt)/(c-P),E=(i-2*nt)/(S-v);return s.map((f,k)=>k%3===0?(f-P)*$+nt:k%3===1?i-((f-v)*E+nt):f)};F(mt.vertices);let p=null,W=()=>{};const z=()=>{W();const s=Object.keys(w)[b];J(s)},K=()=>{W(),p&&p.canvas.remove(),j={...C};const s=new Map;for(const i in y)if(!(w[i].path.length==0||y[i].length==0))if(y[i].length==1)s.set(w[i].path[0],[y[i][0].x,y[i][0].y,0]);else if(y[i].length==2)s.set(w[i].path[0],[y[i][0].x,y[i][0].y,0]),s.set(w[i].path[1],[y[i][1].x,y[i][1].y,0]);else{const r=vt(y[i],i);for(var a=0;a<w[i].path.length;a++)s.set(w[i].path[a],r[a])}p=new Tt(s,C,new rt),p.canvas.style.position="absolute",p.canvas.style.top="50%",p.canvas.style.left="50%",p.canvas.style.transform=`translate(${-t.getBoundingClientRect().width/(2*_())}px, ${-t.getBoundingClientRect().height/(2*_())}px) translate(${p.imageBBox.minX}px, ${p.imageBBox.minY}px)`,p.canvas.style.pointerEvents="none",t.after(p.canvas)},vt=(s,a)=>{const i=new rt().calculateCompositeEmotion(C),r=w[a].path.map((f,k)=>{const M=f*3;return[i[M]+A[M],i[M+1]-A[M+1],i[M+2]+A[M+2]]});w[a].closed&&(s.push(s[0]),r.push(r[0]));const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",`M ${r.map((f,k)=>`${f[0]} ${f[1]}`).join(" L ")}`);const P=document.createElementNS("http://www.w3.org/2000/svg","path");P.setAttribute("d",`M ${s.map((f,k)=>`${f.x} ${f.y}`).join(" L ")}`);const v=P.getTotalLength(),c=d.getTotalLength(),S=v/c;let $=P.getPointAtLength(0);const E=[[$.x,$.y,0]];let e=0;for(let f=0;f<r.length-1;f++){const k=r[f],M=r[f+1];e+=Math.hypot(k[0]-M[0],k[1]-M[1]),$=P.getPointAtLength(e*S),E.push([$.x,$.y,0])}return console.log(E),E},xt=(s,a)=>{const r=window.innerHeight*.8;return Math.min(r/a,1)},yt=s=>{s.preventDefault(),s.stopPropagation()},wt=s=>{s.preventDefault(),s.stopPropagation();const a=s.dataTransfer?.files;if(!a||a.length===0)return;const i=a[0];if(!i.type.startsWith("image/")){alert("Please drop an image file");return}const r=new FileReader;r.onload=d=>{const P=new Image;P.onload=()=>{const v=P.width,c=P.height;at({width:v,height:c});const S=xt(v,c);q(S),t&&(t.width=v,t.height=c,h=t.getContext("2d"),h?.drawImage(P,0,0)),l&&(l.setAttribute("width",v.toString()),l.setAttribute("height",c.toString())),Y=h.getImageData(0,0,v,c),x(!0),F(mt.vertices),z()},P.src=d.target?.result},r.readAsDataURL(i)};return Bt(()=>{if(!t||!l||(h=t.getContext("2d"),!u()))return;let s=!1,a={x:0,y:0};const i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",a.x.toString()),i.setAttribute("cy",a.y.toString()),i.setAttribute("r",(5/_()).toString()),i.style.stroke="red",i.style.fill="red";const r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1",a.x.toString()),r.setAttribute("y1",a.y.toString()),r.setAttribute("x2",a.x.toString()),r.setAttribute("y2",a.y.toString()),r.style.stroke="red",r.style.fill="red";const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",`M ${a.x} ${a.y} L ${a.x} ${a.y}`),d.style.stroke="red",d.style.fill="rgba(255,0,0,0.2)";const P=v=>{const c=l.getBoundingClientRect(),S=(v.clientX-c.left)/_(),$=(v.clientY-c.top)/_();return{x:S,y:$}};W=()=>{i.remove(),r.remove(),d.remove()},l.onmousedown=v=>{if(b==null)return;const c=Object.keys(w)[b];v.preventDefault(),v.stopPropagation();const{x:S,y:$}=P(v);s=!0,a={x:S,y:$},y[c]=[],w[c].path.length==1?(i.setAttribute("cx",S.toString()),i.setAttribute("cy",$.toString()),l.appendChild(i)):w[c].path.length==2?(y[c].push(a),r.setAttribute("x1",a.x.toString()),r.setAttribute("y1",a.y.toString()),r.setAttribute("x2",a.x.toString()),r.setAttribute("y2",a.y.toString()),l.appendChild(r)):(y[c].push(a),d.setAttribute("d","M "+y[c].map((E,e)=>`${E.x} ${E.y}`).join(" L ")),l.appendChild(d))},l.onmousemove=v=>{if(b==null)return;const c=Object.keys(w)[b];if(v.preventDefault(),v.stopPropagation(),s){const{x:S,y:$}=P(v);w[c].path.length==1?(i.setAttribute("cx",S.toString()),i.setAttribute("cy",$.toString())):w[c].path.length==2?(r.setAttribute("x2",S.toString()),r.setAttribute("y2",$.toString())):(y[c].push({x:S,y:$}),d.setAttribute("d","M "+y[c].map((E,e)=>`${E.x} ${E.y}`).join(" L ")))}},l.onmouseup=v=>{if(b==null)return;const c=Object.keys(w)[b];v.preventDefault(),v.stopPropagation(),s=!1;const{x:S,y:$}=P(v);w[c].path.length==1?y[c].push(a):w[c].path.length==2?y[c].push({x:S,y:$}):(y[c].push({x:S,y:$}),y[c].push({x:a.x,y:a.y}),d.setAttribute("d","M "+y[c].map((E,e)=>`${E.x} ${E.y}`).join(" L "))),b++,b=Math.min(b,Object.keys(w).length),z()}}),(()=>{var s=L(Yt),a=s.firstChild,i=a.firstChild,r=i.nextSibling,d=r.nextSibling,P=a.nextSibling,[v,c]=it(P.nextSibling);s.addEventListener("drop",wt),s.addEventListener("dragover",yt);var S=g;typeof S=="function"?st(S,s):g=s,m(s,"position","relative"),m(s,"display","flex"),m(s,"border","2px dashed #ccc"),m(s,"padding","10px"),m(s,"cursor","pointer"),m(s,"width","100vw"),m(s,"height","100vh"),m(s,"background","rgba(255,0,0,.1)"),m(a,"position","relative"),m(a,"display","flex"),m(i,"position","absolute"),m(i,"top","50%"),m(i,"left","50%"),m(i,"transform","translate(-50%, -50%)"),m(i,"color","#999"),m(i,"background","white");var $=t;typeof $=="function"?st($,r):t=r,m(r,"display","block");var E=l;return typeof E=="function"?st(E,d):l=d,m(d,"position","absolute"),m(d,"top","50%"),m(d,"left","50%"),m(d,"transform","translate(-50%, -50%)"),m(d,"filter","invert(1)"),D(s,Z(_t,{title:"Pareidolia",emotionModel:n,callback:e=>{C=e;const f={...C};for(var k in j)f[k]-=j[k];if(p){const N=new Uint8ClampedArray(p.canvas.width*p.canvas.height*4).fill(0),Q=B().width;for(var M=0;M<p.canvas.height;M++)for(var I=0;I<p.canvas.width;I++){if(p.mask[M*p.canvas.width+I]==0)continue;const G=p.transformXY(f,I+p.imageBBox.minX,M+p.imageBBox.minY),O=(M*p.canvas.width+I)*4,R=(Math.round(G[1])*Q+Math.round(G[0]))*4;N[O]=Y.data[R],N[O+1]=Y.data[R+1],N[O+2]=Y.data[R+2],N[O+3]=Y.data[R+3]}p.ctx.putImageData(new ImageData(N,p.canvas.width,p.canvas.height),0,0)}},get children(){return[(()=>{var e=L(Ct);return D(e,(()=>{var f=ct(()=>X()in w);return()=>f()?w[X()].name:"Upload an Image"})()),e})(),(()=>{var e=L(Dt);return D(e,(()=>{var f=ct(()=>X()in w);return()=>f()?w[X()].description:"Drag and drop an image to get started."})()),e})(),(()=>{var e=L(jt);return e.$$click=()=>{b=Math.max(0,b-1),z()},U(),e})(),(()=>{var e=L(It);return e.$$click=()=>{y[X()]=[],b++,b>=Object.keys(w).length&&(b=0),z()},U(),e})(),(()=>{var e=L(Nt);return e.$$click=()=>{b++,b>=Object.keys(w).length&&(b=0),z()},U(),e})(),L(Ht),(()=>{var e=L(Xt);return e.$$click=()=>{K()},U(),e})()]}}),v,c),dt(e=>{var f=`scale(${_()})`,k=u()?B().width*_()+"px":"auto",M=u()?B().height*_()+"px":"auto",I=u()?"none":"block",N=B().width,Q=B().height,G=u()?`${-.5/_()}em ${.5/_()}em 0 rgba(0,0,0,.5), ${-1/_()}em ${1/_()}em 0 gray`:"none",O=B().width,R=B().height,lt=u()?"auto":"none",ht=`${5/_()}px`;return f!==e.e&&m(a,"transform",e.e=f),k!==e.t&&m(a,"width",e.t=k),M!==e.a&&m(a,"height",e.a=M),I!==e.o&&m(i,"display",e.o=I),N!==e.i&&tt(r,"width",e.i=N),Q!==e.n&&tt(r,"height",e.n=Q),G!==e.s&&m(r,"box-shadow",e.s=G),O!==e.h&&tt(d,"width",e.h=O),R!==e.r&&tt(d,"height",e.r=R),lt!==e.d&&m(d,"pointer-events",e.d=lt),ht!==e.l&&m(d,"stroke-width",e.l=ht),e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0}),s})()};ft(["click"]);var Rt=T("<div>"),Ft=T('<div class="flex items-center justify-center h-full"><div class=text-center><p class=text-lg>Loading pareidolia...');const Wt=()=>{const o=new rt;return(()=>{var t=L(Rt);return m(t,"width","100vw"),m(t,"height","100vh"),D(t,Z(kt,{get fallback(){return L(Ft)},get children(){return Z(Ot,{emotionModel:o})}})),t})()};export{Wt as default};
