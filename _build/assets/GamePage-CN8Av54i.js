import{b as dt,t as H,w as N,I as T,H as c,A as j,i as G,d as Y,z as Z,J as ct,K as L,q as ht,M as mt}from"./web-BjSrF1zk.js";import{N as A,a as it,E as nt,S as gt,O as ut,V as pt,F as vt,A as ft,D as tt}from"./Face-CMEODpwO.js";import"./ClientOnly-B3hFWBc-.js";class et{static tanh(t){return Math.tanh(t)}static tanhDerivative(t){const e=Math.tanh(t);return 1-e*e}static elu(t,e=1){return t>=0?t:e*(Math.exp(t)-1)}static eluDerivative(t,e=1){return t>=0?1:e*Math.exp(t)}static swish(t){return t/(1+Math.exp(-t))}static swishDerivative(t){const e=1/(1+Math.exp(-t));return e+t*e*(1-e)}static gelu(t){return .5*t*(1+Math.tanh(Math.sqrt(2/Math.PI)*(t+.044715*t*t*t)))}static geluDerivative(t){const e=Math.sqrt(2/Math.PI),o=t+.044715*t*t*t,l=Math.tanh(e*o),x=1-l*l;return .5*(1+l)+.5*t*x*e*(1+3*.044715*t*t)}static leakyRelu(t,e=.01){return t>0?t:e*t}static leakyReluDerivative(t,e=.01){return t>0?1:e}}const wt={swish:[et.swish,et.swishDerivative]};class St{id;row;column;internalState;idealState;transitions;rotation;targetRotation;targetState;dim;isPaired;expressionModel;bias;constructor(t,e,o){this.id=t,this.row=e,this.column=o,this.internalState=Object.values(A).map(()=>Math.random()*.5-.25),this.bias=Object.values(A).map(()=>Math.random()*.2-.1),this.dim=this.internalState.length,this.transitions=new Array(this.dim).fill(0).map((l,x)=>new Array(this.dim).fill(0).map((p,$)=>Math.random()*1-.5)),this.rotation=[0,0,0],this.targetRotation=[0,0,0],this.targetState=[...this.internalState],this.isPaired=!1,this.expressionModel=new it(new nt)}interact(t,e,o){this.isPaired=!0;const[l,x]=wt.swish,p=[];for(let s=0;s<this.dim;s++){let v=this.bias[s];for(let f=0;f<this.dim;f++)v+=this.transitions[s][f]*t[f];p.push(v)}const $=p.map(s=>l(s)),b=[...this.internalState];for(let s=0;s<this.dim;s++)b[s]+=$[s];this.targetState=b.map(s=>Math.tanh(s));const M=[];let P=0;for(let s=0;s<this.dim;s++){const v=o[s]-this.targetState[s];M.push(v),P+=v*v}P/=this.dim;for(let s=0;s<this.dim;s++){const v=-2*M[s]/this.dim,f=1-Math.tanh(b[s])**2,i=1,n=x(p[s]);for(let h=0;h<this.dim;h++){const g=t[h],u=v*f*i*n*g;this.transitions[s][h]-=e*u}const m=v*f*i*n*1;this.bias[s]-=e*m}return{loss:P,errors:M,delta:$,bias:[...this.bias]}}rotate(t){this.targetRotation=[...t]}update(t){for(let e=0;e<this.rotation.length;e++)this.rotation[e]+=(this.targetRotation[e]-this.rotation[e])*t*4;for(let e=0;e<this.dim;e++)this.internalState[e]+=(this.targetState[e]-this.internalState[e])*t}getExpression(t){const e=this.expressionModel.getExpression(this.internalState.map(l=>l*t));for(var o=1;o<e.children.length;o++){const l=e.children[o];l.position.set(l.position.x+this.rotation[1]*.2,l.position.y+this.rotation[0]*.3,l.position.z-Math.abs(this.rotation[1]*.1))}return e.rotation.set(...this.rotation),e.position.set(this.column*5,this.row*5,0),e}faceDirection(t,e){const o=[0,0,0];t==1?o[1]=Math.PI/5:t==-1&&(o[1]=-Math.PI/5),e==-1?o[0]=Math.PI/8:e==1&&(o[0]=-Math.PI/8),this.targetRotation=o}}var Mt=N('<div id=game-container style=text-align:center;flex-direction:row;align-items:center;justify-content:center><div class="game pixelated-border"><!$><!/><div class=halftone></div><div id=loading>Loading...</div></div><div style=flex-direction:column;align-items:center;justify-content:center;width:300px><h1>Games with Emotions</h1><div id=controls><h4>Homeostasis</h4><!$><!/><!$><!/><h4>Settings</h4><div style=align-items:center><input type=range min=-14 max=0><span>Learning Rate</span></div><div style=align-items:center><input type=range min=100 max=10000><span>Animation Speed</span></div><div style=align-items:center><input type=range min=80 max=1000><span>Intensity</span></div><div style=align-items:center><input type=range min=0 max=10><span>Extroversion'),xt=N("<div style=align-items:center><input type=range min=-100 max=100><span>");let R=1,B=400;const S=Object.keys(A).reduce((r,t)=>(r[t]=Math.random()*80-40,r),{});let z=40,I=[...Object.keys(S).map(r=>S[r]/z)],X=1;const yt=r=>{const t=new gt(r.width,r.height);t.camera=new ut(-2.5*r.gridSize,2.5*r.gridSize,2.5*r.gridSize,-2.5*r.gridSize,.01,100),t.camera.position.set(2.5*(r.gridSize-1),2.5*(r.gridSize-1),10),t.camera.updateProjectionMatrix(),r.gridSize*1.25;let e=!1;t.renderer.domElement.addEventListener("pointerdown",i=>{i.preventDefault(),e=!0,i.clientX,i.clientY}),window.addEventListener("pointerup",i=>{i.preventDefault(),e=!1}),window.addEventListener("pointercancel",i=>{i.preventDefault(),e=!1}),t.renderer.domElement.addEventListener("pointermove",i=>{if(i.preventDefault(),e){const n=(t.camera.right-t.camera.left)/t.renderer.domElement.width,a=-i.movementX*n,m=i.movementY*n;t.camera.position.x+=a,t.camera.position.y+=m}i.clientX,i.clientY}),t.renderer.domElement.addEventListener("wheel",i=>{i.preventDefault();const n=t.renderer.domElement.getBoundingClientRect(),a=(i.clientX-n.left)/n.width*2-1,m=-((i.clientY-n.top)/n.height)*2+1,h=new pt(a,m,0);h.unproject(t.camera),h.z=0;const g=i.deltaY>0?.95:1.05,u=h.clone();t.camera.top*=g,t.camera.bottom*=g,t.camera.left*=g,t.camera.right*=g,t.camera.updateProjectionMatrix(),h.set(a,m,0),h.unproject(t.camera),h.z=0,t.camera.position.x+=u.x-h.x,t.camera.position.y+=u.y-h.y}),r.expressionModel;let o=[],l=0,x=performance.now(),p=0,$=!1;const b=new Worker(new URL("/expressions/_build/assets/AgentWorker-BpgoObOu.js",import.meta.url),{type:"module"});b.onmessage=i=>{i.data.type==="agents-created"&&(o=i.data.agents.map(n=>{const a=new St(n.id,n.row,n.column);return a.internalState=n.internalState,a.bias=n.bias,a.transitions=n.transitions,a.rotation=n.rotation,a.targetRotation=n.targetRotation,a.targetState=n.targetState,a.dim=n.dim,a.isPaired=n.isPaired,a}),document.getElementById("loading")?.remove(),$=!0,M())},b.postMessage({type:"init",data:{gridSize:r.gridSize}});const M=()=>{if(!$){requestAnimationFrame(M);return}if(p<=0){s();return}const i=performance.now();l=i-x,x=i;let n=Math.max(0,Math.min(1,p>0?l/p:0));for(const a of o)a.update(n);P(),p=Math.max(p-l,0),requestAnimationFrame(M)},P=()=>{t.scene.clear();const i=new ft(11141239,3),n=new tt(13408682,1);n.position.set(-2,4.5,9);const a=new tt(10070732,4);a.position.set(3,3,5),t.scene.add(i),t.scene.add(n),t.scene.add(a);for(const m of o){const h=m.getExpression(z);t.add(h)}t.render()},s=()=>{for(const a of o)a.isPaired=!1;for(var i=0;i<r.gridSize;i++)for(var n=0;n<r.gridSize;n++){const a=o[i*r.gridSize+n];if(!a.isPaired){let m=!0,h=0;for(;m&&h<X;){h++;let g=Math.round(Math.random()*2.98-1.49),u=Math.round(Math.random()*2.98-1.49);const _=Math.max(0,Math.min(r.gridSize-1,n+g)),C=Math.max(0,Math.min(r.gridSize-1,i+u));if(g=_-n,u=C-i,g==0&&u==0)continue;const y=o[C*r.gridSize+_];y&&!y.isPaired&&(a.interact(y.internalState,R,I),y.interact(a.internalState,R,I),a.faceDirection(g,u),y.faceDirection(-g,-u),m=!1)}m&&(a.interact(a.internalState,R,I),a.rotate([0,0,0]))}}p=B,requestAnimationFrame(M)},[v,f]=dt(S);return(()=>{var i=H(Mt),n=i.firstChild,a=n.firstChild,[m,h]=T(a.nextSibling);m.nextSibling;var g=n.nextSibling,u=g.firstChild,_=u.nextSibling,C=_.firstChild,y=C.nextSibling,[V,at]=T(y.nextSibling),rt=V.nextSibling,[W,st]=T(rt.nextSibling),ot=W.nextSibling,O=ot.nextSibling,J=O.firstChild,D=O.nextSibling,K=D.firstChild,k=D.nextSibling,U=k.firstChild,F=k.nextSibling,Q=F.firstChild;return c(i,"position","relative"),c(i,"width","100%"),c(i,"height","calc(100% - 2em)"),c(i,"padding","1em"),c(i,"display","flex"),c(n,"position","relative"),j(n,()=>t.renderer.domElement,m,h),c(g,"display","flex"),j(_,G(vt,{id:"face",width:140,height:140,get expressionModel(){return r.expressionModel},get emotionLevels(){return v()}}),V,at),j(_,G(ct,{get each(){return Object.keys(A)},children:d=>(()=>{var w=H(xt),E=w.firstChild,q=E.nextSibling;return c(w,"display","flex"),c(w,"gap","10px"),E.$$input=lt=>{S[d]=parseInt(lt.target.value),I[Object.keys(A).indexOf(d)]=S[d]/z,f({...S})},j(q,()=>String(d)),Y(()=>L(E,"value",S[d])),Z(),w})()}),W,st),c(O,"display","flex"),c(O,"gap","10px"),J.$$input=d=>{R=10**parseInt(d.target.value)},c(D,"display","flex"),c(D,"gap","10px"),K.$$input=d=>{B=10100-parseInt(d.target.value)},L(K,"value",10100-B),c(k,"display","flex"),c(k,"gap","10px"),U.$$input=d=>{z=parseInt(d.target.value),I=[...Object.keys(S).map(w=>S[w]/z)]},L(U,"value",z),c(F,"display","flex"),c(F,"gap","10px"),Q.$$input=d=>{X=parseInt(d.target.value)},L(Q,"value",X),Y(d=>{var w=r.id,E=r.width+"px",q=r.height+"px";return w!==d.e&&mt(n,"id",d.e=w),E!==d.t&&c(n,"width",d.t=E),q!==d.a&&c(n,"height",d.a=q),d},{e:void 0,t:void 0,a:void 0}),Y(()=>L(J,"value",Math.log10(R))),Z(),i})()};ht(["input"]);var $t=N("<div>");const zt=()=>{const r=new nt,t=new it(r);let e=140,o=24;return(()=>{var l=H($t);return c(l,"width","100vw"),c(l,"height","100vh"),j(l,G(yt,{id:"game",get width(){return Math.min(e*o,window.innerWidth*.95,window.innerHeight*.95)},get height(){return Math.min(e*o,window.innerWidth*.95,window.innerHeight*.95)},expressionModel:t,gridSize:o})),l})()};export{zt as default};
